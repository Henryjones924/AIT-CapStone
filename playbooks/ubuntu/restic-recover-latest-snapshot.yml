- name: Recovery from latest snapshot
  hosts: node
  become: true
  vars_files:
    - ../../vault/secrets.yml
  vars:
    ansible_become_password: "{{ sudo_password }}"

  tasks:
    - name: Stop Compose Monitoring
      community.docker.docker_compose_v2:
        project_src: /opt/docker/compose/monitoring/
        state: absent
      register: output

    - name: Stop Compose Services
      community.docker.docker_compose_v2:
        project_src: /opt/docker/compose/services/
        state: absent
      register: output

    - name: Stop Docker Deamon
      service:
        name: docker
        state: stopped

    - name: Remove Docker Volumnes
      ansible.builtin.file:
        path: /opt/docker/165536.165536/volumes
        state: absent

    - name: Recover From Latest Snapshot
      command: >
        restic restore latest --target /
      environment:
        RESTIC_REPOSITORY: /backup/restic
        RESTIC_PASSWORD_FILE: /backup/.env
        target: /

    - name: Start Docker Deamon
      service:
        name: docker
        state: started
